# 📝 quiz_view.py v2.2 - タイムアウト処理の追加

## 🆕 v2.2の変更内容

### タイムアウト処理の実装

クイズセッションが時間切れ（5分）になった場合の適切なユーザー体験を実装しました。

---

## 🎯 実装した機能

### 1. タイムアウト時の自動処理（on_timeout）

**5分経過すると自動的に:**
- すべてのボタンが無効化される
- タイムアウトメッセージが表示される
- 途中経過のスコアが表示される

**表示されるメッセージ:**
```
⏰ タイムアウト

クイズセッションの制限時間（5分）が経過しました。

正解数: X/Y問

新しくコマンドを入力してセッションを開始してください。
```

---

### 2. タイムアウト後のボタン押下対策

**問題:**
- タイムアウト後にユーザーがボタンを押すと「インタラクションに失敗しました」というエラーが出る
- ユーザーは何が起きたか分からず困惑する

**解決策:**
- タイムアウト後にボタンが押された場合、分かりやすいメッセージを表示

**表示されるメッセージ:**
```
⏰ このクイズセッションは時間切れで終了しました。
新しくコマンドを入力してセッションを開始してください。
```

※ このメッセージは本人のみに表示（ephemeral）

---

## 🔧 実装の詳細

### on_timeoutメソッド

```python
async def on_timeout(self):
    """
    タイムアウト時の処理（5分経過）
    """
    # ボタンを無効化
    for item in self.children:
        item.disabled = True
    
    # タイムアウトメッセージを表示
    timeout_embed = discord.Embed(
        title="⏰ タイムアウト",
        description=f"クイズセッションの制限時間（5分）が経過しました。\n\n**正解数:** {self.correct_count}/{self.current_question_index}問\n\n新しくコマンドを入力してセッションを開始してください。",
        color=discord.Color.orange()
    )
    
    try:
        await self.interaction.edit_original_response(embed=timeout_embed, view=self)
    except:
        pass  # メッセージが削除されている場合などのエラーを無視
```

**ポイント:**
- `for item in self.children: item.disabled = True` ですべてのボタンを無効化
- `discord.Color.orange()` でオレンジ色の警告色を使用
- 途中経過のスコア（`self.correct_count}/{self.current_question_index}問`）を表示
- `try-except` でメッセージが既に削除されている場合のエラーを回避

---

### button_callbackのタイムアウトチェック

```python
async def button_callback(self, interaction: discord.Interaction):
    """
    いずれかの選択肢ボタンが押されたときの処理
    """
    
    # 🔽 タイムアウトチェック (v2.2)
    if self.is_finished():
        await interaction.response.send_message(
            "⏰ このクイズセッションは時間切れで終了しました。\n新しくコマンドを入力してセッションを開始してください。",
            ephemeral=True
        )
        return
    
    # 以下、通常の処理...
```

**ポイント:**
- `self.is_finished()` でViewがタイムアウトしているかチェック
- タイムアウト済みの場合、`ephemeral=True` でユーザーのみにメッセージを表示
- `return` で処理を中断し、通常のクイズ処理に進まない

---

## 🎨 ユーザー体験の改善

### ケース1: 途中でタイムアウトした場合

```
ユーザーが問題3に回答中
  ↓
5分経過（タイムアウト）
  ↓
on_timeout() が自動実行
  ↓
画面が更新される:
  ⏰ タイムアウト
  クイズセッションの制限時間（5分）が経過しました。
  正解数: 2/3問
  新しくコマンドを入力してセッションを開始してください。
  ↓
ボタンがグレーアウト（無効化）
```

---

### ケース2: タイムアウト後にボタンを押した場合

```
ユーザーが問題を見ている
  ↓
5分経過（タイムアウト）
  ↓
ユーザーが気づかずにボタンを押す
  ↓
button_callback() でタイムアウトチェック
  ↓
エラーメッセージが表示される（本人のみ）:
  ⏰ このクイズセッションは時間切れで終了しました。
  新しくコマンドを入力してセッションを開始してください。
```

**改善前:**
- 「インタラクションに失敗しました」という技術的なエラー
- 何が起きたか分からず困惑

**改善後:**
- 分かりやすい日本語のメッセージ
- 次にやるべきこと（新しいコマンドを入力）が明確

---

## 🔍 技術的なポイント

### discord.ui.Viewのタイムアウト機能

```python
def __init__(self, questions: list[QuizData], bot_title: str):
    super().__init__(timeout=300.0)  # 5分（300秒）でタイムアウト
```

**動作:**
- 最後のインタラクションから5分経過すると自動的にタイムアウト
- タイムアウトすると`on_timeout()`が呼ばれる
- `self.is_finished()` が `True` を返すようになる

---

### ephemeralメッセージの使い分け

| 状況 | 表示方法 | 誰が見られる？ |
|------|---------|---------------|
| タイムアウト時の自動更新 | `edit_original_response` | 全員 |
| タイムアウト後のボタン押下 | `send_message(ephemeral=True)` | 本人のみ |

**理由:**
- タイムアウトは「セッション終了」という公開情報なので全員に表示
- ボタン押下は「操作ミス」なので本人のみに優しく通知

---

## 🧪 テスト方法

### テスト1: 通常のタイムアウト

1. クイズを開始
2. **5分間放置**（長いので、開発中は`timeout=10.0`に変更してテスト可能）
3. タイムアウトメッセージが表示されることを確認
4. ボタンがグレーアウトすることを確認

### テスト2: タイムアウト後のボタン押下

1. 上記のテスト1を実行してタイムアウトさせる
2. グレーアウトしたボタンを押す
3. エラーメッセージが表示されることを確認
4. メッセージが「あなただけが見ることができます」と表示されることを確認

### 開発中のテストのヒント

`timeout=300.0`（5分）では長すぎるので、テスト中は一時的に短縮できます：

```python
# テスト用: 10秒でタイムアウト
super().__init__(timeout=10.0)

# 本番用: 5分でタイムアウト
super().__init__(timeout=300.0)
```

---

## 📊 タイムアウトが発生するケース

### 発生しやすいケース
1. **ユーザーが席を離れた**
   - トイレ、電話対応などで放置
2. **じっくり考えている**
   - 難しい問題で長時間悩んでいる
3. **複数のことを同時進行**
   - 他のチャンネルとの並行作業

### 発生しにくいケース
- 通常のクイズプレイ（10〜20問を数分で回答）

### タイムアウト時間（5分）の妥当性
- ✅ 通常のプレイでは余裕がある
- ✅ 完全に放置されたセッションを適切にクリーンアップ
- ⚠️ じっくり考えたいユーザーには少し短い？

**必要に応じて変更可能:**
```python
# より長い制限時間（10分）
super().__init__(timeout=600.0)

# より短い制限時間（3分）
super().__init__(timeout=180.0)
```

---

## ✅ 確認ポイント

### v2.2で実装された機能
- ✅ タイムアウト時の自動メッセージ表示
- ✅ タイムアウト後のボタン押下時のエラーハンドリング
- ✅ ユーザーフレンドリーなメッセージ
- ✅ 途中経過のスコア表示

### 改善されたユーザー体験
- ✅ 技術的なエラーメッセージの排除
- ✅ 分かりやすい日本語のガイダンス
- ✅ 次のアクション（新しいコマンド入力）の明示
- ✅ プライバシー保護（ephemeral）

---

## 🚀 デプロイ手順

### ステップ1: ローカルでテスト

```powershell
# bot.pyを停止
Ctrl + C

# 新しいquiz_view.pyを配置
# C:\Users\fujik\OneDrive\デスクトップ\music-quiz-bot\utils\quiz_view.py

# bot.pyを再起動
python bot.py
```

### ステップ2: タイムアウトをテスト（オプション）

開発中は一時的にタイムアウトを短縮してテスト：

```python
# quiz_view.py の __init__ を一時的に変更
super().__init__(timeout=10.0)  # 10秒でタイムアウト
```

1. クイズを開始
2. 10秒放置
3. タイムアウトメッセージが表示されることを確認
4. ボタンを押してエラーメッセージを確認

テスト完了後、元に戻す：
```python
super().__init__(timeout=300.0)  # 5分でタイムアウト
```

### ステップ3: GitHubにプッシュ

```powershell
git add utils/quiz_view.py
git commit -m "feat: クイズタイムアウト処理を追加（5分経過時の適切なメッセージ表示）"
git push origin main
```

### ステップ4: Renderで自動デプロイ

GitHubにプッシュすると3〜5分後に自動デプロイされます。

---

**最終更新:** 2025/11/18
**バージョン:** v2.2
**機能:** タイムアウト処理の追加
